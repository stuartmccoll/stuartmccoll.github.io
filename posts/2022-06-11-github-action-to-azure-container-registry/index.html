<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Stuart McColl "><meta name=description content="Building and pushing Docker images to Azure Container Registry is simple with a small GitHub Actions workflow.
This blog post assumes you&amp;rsquo;ve got a docker-compose.yml file in your GitHub repository. If you&amp;rsquo;re just using a Dockerfile, you&amp;rsquo;ll need to make a tiny amendment to the Build Docker image step in the push-to-acr.yml file described below.
Microsoft Azure setup/configuration If you&amp;rsquo;re starting fresh, in terms of our Azure setup we&amp;rsquo;ll need:"><meta name=keywords content="homepage,blog,development,programming"><meta name=robots content="noodp"><link rel=canonical href=https://stuartmccoll.github.io/posts/2022-06-11-github-action-to-azure-container-registry/><title>Push a Docker image to Azure Container Registry using a GitHub Actions workflow :: Stuart McColl</title><link rel=stylesheet href=/main.min.15c204e66791e2f70ca06e7872b0ed743b4d2392b3c6dc31ba8dbd9f3d4618d2.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><meta name=theme-color content="#252627"><meta itemprop=name content="Push a Docker image to Azure Container Registry using a GitHub Actions workflow"><meta itemprop=description content="Building and pushing Docker images to Azure Container Registry is simple with a small GitHub Actions workflow.
This blog post assumes you&rsquo;ve got a docker-compose.yml file in your GitHub repository. If you&rsquo;re just using a Dockerfile, you&rsquo;ll need to make a tiny amendment to the Build Docker image step in the push-to-acr.yml file described below.
Microsoft Azure setup/configuration If you&rsquo;re starting fresh, in terms of our Azure setup we&rsquo;ll need:"><meta itemprop=datePublished content="2022-06-11T11:15:00+01:00"><meta itemprop=dateModified content="2022-06-11T11:15:00+01:00"><meta itemprop=wordCount content="614"><meta itemprop=image content="https://stuartmccoll.github.io"><meta itemprop=keywords content="Automation,GitHub Actions,Microsoft Azure,"><meta property="article:section" content="Automation"><meta property="article:section" content="GitHub Actions"><meta property="article:section" content="Microsoft Azure"><meta property="article:published_time" content="2022-06-11 11:15:00 +0100 +0100"><script type=text/javascript>!function(b,d,a){var e=b.location,o="script",n="instrumentationKey",g="ingestionendpoint",k="disableExceptionTracking",i="ai.device.",j="toLowerCase",h="crossOrigin",l="POST",m="appInsightsSDK",f=a.name||"appInsights",c;(a.name||b[m])&&(b[m]=f),c=b[f]||function(f){var z=!1,q=!1,c={initialize:!0,queue:[],sv:"5",version:2,config:f},r,s,m,x,y,B,p,A;function w(b,f){var a={},d="Browser";return a[i+"id"]=d[j](),a[i+"type"]=d,a["ai.operation.name"]=e&&e.pathname||"_unknown_",a["ai.internal.sdkVersion"]="javascript:snippet_"+(c.sv||c.version),{time:function(){var a=new Date;function b(b){var a=""+b;return 1===a.length&&(a="0"+a),a}return a.getUTCFullYear()+"-"+b(1+a.getUTCMonth())+"-"+b(a.getUTCDate())+"T"+b(a.getUTCHours())+":"+b(a.getUTCMinutes())+":"+b(a.getUTCSeconds())+"."+((a.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:b,name:"Microsoft.ApplicationInsights."+b.replace(/-/g,"")+"."+f,sampleRate:100,tags:a,data:{baseData:{ver:2}}}}if(r=f.url||a.src,r){function u(x){var h,i,t,u,v,s,o,p,k,d,m;z=!0,c.queue=[],q||(q=!0,h=r,o=function(){var a={},d=f.connectionString,e,b,c,h,i;if(d)for(e=d.split(";"),b=0;b<e.length;b++)c=e[b].split("="),2===c.length&&(a[c[0][j]()]=c[1]);return a[g]||(h=a.endpointsuffix,i=h?a.location:null,a[g]="https://"+(i?i+".":"")+"dc."+(h||"services.visualstudio.com")),a}(),p=o[n]||f[n]||"",k=o[g],d=k?k+"/v2/track":f.endpointUrl,(m=[]).push((i="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",t=h,u=d,(s=(v=w(p,"Exception")).data).baseType="ExceptionData",s.baseData.exceptions=[{typeName:"SDKLoadFailed",message:i.replace(/\./g,"-"),hasFullStack:!1,stack:i+"\nSnippet failed to load ["+t+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(e&&e.pathname||"_unknown_")+"\nEndpoint: "+u,parsedStack:[]}],v)),m.push(function(g,f,d,e){var b=w(p,"Message"),c=b.data,a;return c.baseType="MessageData",a=c.baseData,a.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+d+")").replace(/\"/g,"")+'"',a.properties={endpoint:e},b}(0,0,h,d)),function(e,f){var d,c;JSON&&(d=b.fetch,d&&!a.useXhr?d(f,{method:l,body:JSON.stringify(e),mode:"cors"}):XMLHttpRequest&&(c=new XMLHttpRequest,c.open(l,f),c.setRequestHeader("Content-type","application/json"),c.send(JSON.stringify(e))))}(m,d))}function t(b,a){q||setTimeout(function(){!a&&c.core||u()},500)}s=function(){var b=d.createElement(o),c;return b.src=r,c=a[h],!c&&""!==c||"undefined"==b[h]||(b[h]=c),b.onload=t,b.onerror=u,b.onreadystatechange=function(c,a){"loaded"!==b.readyState&&"complete"!==b.readyState||t(0,a)},b}(),a.ld<0?d.getElementsByTagName("head")[0].appendChild(s):setTimeout(function(){d.getElementsByTagName(o)[0].parentNode.appendChild(s)},a.ld||0)}try{c.cookie=d.cookie}catch(a){}function v(a){for(;a.length;)!function(a){c[a]=function(){var b=arguments;z||c.queue.push(function(){c[a].apply(c,b)})}}(a.pop())}return m="track",x="TrackPage",y="TrackEvent",v([m+"Event",m+"PageView",m+"Exception",m+"Trace",m+"DependencyData",m+"Metric",m+"PageViewPerformance","start"+x,"stop"+x,"start"+y,"stop"+y,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),c.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4},B=(f.extensionConfig||{}).ApplicationInsightsAnalytics||{},!0!==f[k]&&!0!==B[k]&&(p="onerror",v(["_"+p]),A=b[p],b[p]=function(a,b,d,e,f){var g=A&&A(a,b,d,e,f);return!0!==g&&c["_"+p]({message:a,url:b,lineNumber:d,columnNumber:e,error:f}),g},f.autoExceptionInstrumented=!0),c}(a.cfg);function p(){a.onInit&&a.onInit(c)}(b[f]=c).queue&&0===c.queue.length?(c.queue.push(p),c.trackPageView({})):p()}(window,document,{src:"https://js.monitor.azure.com/scripts/b/ai.2.min.js",crossOrigin:"anonymous",cfg:{connectionString:"InstrumentationKey=74cc5c48-d066-4928-932e-459f438b579d;IngestionEndpoint=https://uksouth-1.in.applicationinsights.azure.com/;LiveEndpoint=https://uksouth.livediagnostics.monitor.azure.com/"}})</script></head><body><div class=container><header><section><h1 class=site-heading>Stuart McColl</h1><nav><ul><li><a href=/>Blog</a></li><li><a href=/about>About</a></li></ul></nav></section></header><hr><div class=content><main class=post><article><header><h1 class=post-title>Push a Docker image to Azure Container Registry using a GitHub Actions workflow</h1><p class=post-date>June 11, 2022</p></header><hr class=post-rule><div class=post-content><p>Building and pushing Docker images to Azure Container Registry is simple with
a small GitHub Actions workflow.</p><p>This blog post assumes you&rsquo;ve got a <code>docker-compose.yml</code> file in your GitHub
repository. If you&rsquo;re just using a <code>Dockerfile</code>, you&rsquo;ll need to make a tiny
amendment to the <code>Build Docker image</code> step in the <code>push-to-acr.yml</code> file
described below.</p><h2 id=microsoft-azure-setupconfiguration>Microsoft Azure setup/configuration</h2><p>If you&rsquo;re starting fresh, in terms of our Azure setup we&rsquo;ll need:</p><ul><li>a Resource Group;</li><li>an Azure Container Registry (ACR);</li><li>and an access key so that we can access our ACR programmatically from our
GitHub Actions workflow.</li></ul><p>If you&rsquo;ve already got this configured, you can skip to the
<a href=#github-actions-workflow>next section</a>.</p><p>I&rsquo;ll use PowerShell to create this. First, our Resource Group.</p><div class=highlight><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nb>New-AzResourceGroup</span> <span class=n>-Name</span> <span class=s2>&#34;mydemoappghatoacr&#34;</span> <span class=n>-Location</span> <span class=s2>&#34;UK South&#34;</span>
</code></pre></div><p>With that done, we&rsquo;ll create our ACR within this Resource Group.</p><div class=highlight><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nb>New-AzContainerRegistry</span> <span class=n>-ResourceGroupName</span> <span class=s2>&#34;mydemoappghatoacr&#34;</span> <span class=n>-Name</span> <span class=s2>&#34;mydemoappghatoacr&#34;</span> <span class=n>-Sku</span> <span class=s2>&#34;Basic&#34;</span> <span class=n>-EnableAdminUser</span>
</code></pre></div><p>Finally, let&rsquo;s grab the access key values we&rsquo;ll need to connect to our ACR
from our GitHub Actions workflow.</p><div class=highlight><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Get-AzContainerRegistryCredential</span> <span class=n>-ResourceGroupName</span> <span class=s2>&#34;mydemoappghatoacr&#34;</span> <span class=n>-Name</span> <span class=s2>&#34;mydemoappghatoacr&#34;</span>
</code></pre></div><p>Make a note of the <code>Username</code> and <code>Password</code> values from this response.</p><h2 id=github-actions-workflow>GitHub Actions workflow</h2><p>Before we create our GitHub Actions workflow, we&rsquo;ll add a couple of Actions
secrets to our GitHub repository. These are encrypted environment variables
that can be used within our GitHub Actions workflow(s), which stops us from
exposing values that we want to remain secure, such as our Microsoft Azure
client ID and secret.</p><p>Head to your GitHub repository, and navigate to the Settings screen. In here,
you should be able to find a Secrets section under the Security subheading.
Secrets currently allows you to configure secrets for Actions, Codespaces,
and Dependabot. Select Actions, and then click &lsquo;New repository secret&rsquo;.</p><p>We&rsquo;ll be adding three Actions secrets:</p><ol><li><code>ACR_REGISTRY_NAME</code>, containing the name of your ACR.</li><li><code>AZ_SP_CLIENT_ID</code> containing the <code>Username</code> value you noted earlier.</li><li><code>AZ_SP_CLIENT_SECRET</code> containing the <code>Password</code> value you noted earlier.</li></ol><p>In your repository, create a new directory named <code>.github</code>. Inside here, we&rsquo;ll
create another new directory named <code>workflows</code>, inside which we&rsquo;ll add a new
empty file named <code>push-to-acr.yml</code>, with the resulting file path being
<code>.\.github\workflows\push-to-acr.yml</code>.</p><p>First, we&rsquo;ll give our workflow a name, and some run configuration. In this
case we&rsquo;re telling GitHub Actions to run this workflow when we push code
to our <code>main</code> branch.</p><p>Secondly, we&rsquo;re checking out the repository code.</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Push to Azure Container Registry</span><span class=w>
</span><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>main</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>push-to-azure-container-registry</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Checkout repository</span><span class=w>
</span><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@main</span><span class=w>
</span></code></pre></div><p>In order for our GitHub Actions workflow to push to ACR, it&rsquo;ll need to
authenticate using the credentials we&rsquo;ve stored as GitHub Actions secrets.
To do this, we&rsquo;ll use the <a href=https://github.com/marketplace/actions/azure-container-registry-login>Azure Container Registry Login</a>
GitHub Action available on the <a href=https://github.com/marketplace>GitHub Marketplace</a>.
This GitHub Action will handle the authentication for us, we just need to
tell it what values to use.</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Login to Azure Container Registry</span><span class=w>
</span><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>azure/docker-login@v1</span><span class=w>
</span><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>login-server</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io</span><span class=w>
</span><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.AZ_SP_CLIENT_ID }}</span><span class=w>
</span><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.AZ_SP_CLIENT_SECRET }}</span><span class=w>
</span></code></pre></div><p>Next, we&rsquo;ll add a simple step to our workflow that will build our Docker image.</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build Docker image</span><span class=w>
</span><span class=w></span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>docker-compose build</span><span class=w>
</span></code></pre></div><p>Our workflow is now capable of checking out our codebase and building our
Docker image. The final step is to push this image to our pre-configured
Azure Container Registry.</p><p>Let&rsquo;s add this final step to our workflow. This last step will tag the image
we&rsquo;ve just built with the Git commit SHA, and then push this tagged image
to ACR.</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Push Docker image to Azure Container Registry</span><span class=w>
</span><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    docker tag mydemoapp:latest ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io/mydemoapp:${{ github.sha }}
</span><span class=sd>    docker push ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io/mydemoapp:${{ github.sha }}</span><span class=w>    
</span></code></pre></div><p>Our full GitHub Actions workflow file looks like the following:</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Push to Azure Container Registry</span><span class=w>
</span><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>main</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>push-to-azure-container-registry</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Checkout repository</span><span class=w>
</span><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@main</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Login to Azure Container Registry</span><span class=w>
</span><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>azure/docker-login@v1</span><span class=w>
</span><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>login-server</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io</span><span class=w>
</span><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.AZ_SP_CLIENT_ID }}</span><span class=w>
</span><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.AZ_SP_CLIENT_SECRET }}</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build Docker image</span><span class=w>
</span><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>docker-compose build</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Push Docker image to Azure Container Registry</span><span class=w>
</span><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>            docker tag mydemoapp:latest ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io/mydemoapp:${{ github.sha }}
</span><span class=sd>            docker push ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io/mydemoapp:${{ github.sha }}</span><span class=w>            
</span></code></pre></div></div></article></main></div><hr><footer><section><h3>More</h3><ul><li><a href=https://hachyderm.io/@stuartmccoll rel=me>Contact me on Mastodon</a></li><li>Spotted a bug in the site?
<a href=https://github.com/stuartmccoll/hugo-theme-refresh/issues/new>Raise an issue on GitHub</a></li><li>Get notifications of new posts by
<a href=https://stuartmccoll.github.io/index.xml>subscribing to my RSS feed</a></li><li>This static site was generated using
<a href=https://github.com/gohugoio/hugo/releases/tag/v0.83.1>Hugo version 0.83.1</a></li></ul></section><hr><section><h3>Attribution</h3><p xmlns:dct=http://purl.org/dc/terms/ xmlns:cc=http://creativecommons.org/ns# class=license-text>This blog post <span rel=dct:title>(Push a Docker image to Azure Container Registry using a GitHub Actions workflow)</span> is licensed under
<a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a>. Any code contained within
this article may be subject to other licenses.</p></section></footer></div></body></html>