<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Stuart McColl "><meta name=description content="Something I&amp;rsquo;ve had to do on more than one occassion recently is copy the contents of one S3 bucket to another S3 bucket. There is no built-in way of doing this in the AWS Management Console, but it is possible using the AWS Command Line Interface (CLI).
As an example, I&amp;rsquo;m going to create two new S3 buckets in my AWS account using Terraform, push some objects into my source bucket, and then copy the contents of this bucket into my target bucket."><meta name=keywords content="homepage,blog,development,programming"><meta name=robots content="noodp"><link rel=canonical href=https://stuartmccoll.github.io/posts/2023-01-14-sync-contents-between-s3-buckets/><title>Sync contents between two S3 Buckets :: Stuart McColl</title><link rel=stylesheet href=/main.min.15c204e66791e2f70ca06e7872b0ed743b4d2392b3c6dc31ba8dbd9f3d4618d2.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><meta name=theme-color content="#252627"><meta itemprop=name content="Sync contents between two S3 Buckets"><meta itemprop=description content="Something I&rsquo;ve had to do on more than one occassion recently is copy the contents of one S3 bucket to another S3 bucket. There is no built-in way of doing this in the AWS Management Console, but it is possible using the AWS Command Line Interface (CLI).
As an example, I&rsquo;m going to create two new S3 buckets in my AWS account using Terraform, push some objects into my source bucket, and then copy the contents of this bucket into my target bucket."><meta itemprop=datePublished content="2023-01-14T11:32:05+00:00"><meta itemprop=dateModified content="2023-01-14T11:32:05+00:00"><meta itemprop=wordCount content="638"><meta itemprop=image content="https://stuartmccoll.github.io"><meta itemprop=keywords content="Amazon Web Services,AWS,S3,Terraform,"><meta property="article:section" content="Amazon Web Services"><meta property="article:section" content="AWS"><meta property="article:section" content="S3"><meta property="article:section" content="Terraform"><meta property="article:published_time" content="2023-01-14 11:32:05 +0000 UTC"><script type=text/javascript>!function(b,d,a){var e=b.location,o="script",n="instrumentationKey",g="ingestionendpoint",k="disableExceptionTracking",i="ai.device.",j="toLowerCase",h="crossOrigin",l="POST",m="appInsightsSDK",f=a.name||"appInsights",c;(a.name||b[m])&&(b[m]=f),c=b[f]||function(f){var z=!1,q=!1,c={initialize:!0,queue:[],sv:"5",version:2,config:f},r,s,m,x,y,B,p,A;function w(b,f){var a={},d="Browser";return a[i+"id"]=d[j](),a[i+"type"]=d,a["ai.operation.name"]=e&&e.pathname||"_unknown_",a["ai.internal.sdkVersion"]="javascript:snippet_"+(c.sv||c.version),{time:function(){var a=new Date;function b(b){var a=""+b;return 1===a.length&&(a="0"+a),a}return a.getUTCFullYear()+"-"+b(1+a.getUTCMonth())+"-"+b(a.getUTCDate())+"T"+b(a.getUTCHours())+":"+b(a.getUTCMinutes())+":"+b(a.getUTCSeconds())+"."+((a.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:b,name:"Microsoft.ApplicationInsights."+b.replace(/-/g,"")+"."+f,sampleRate:100,tags:a,data:{baseData:{ver:2}}}}if(r=f.url||a.src,r){function u(x){var h,i,t,u,v,s,o,p,k,d,m;z=!0,c.queue=[],q||(q=!0,h=r,o=function(){var a={},d=f.connectionString,e,b,c,h,i;if(d)for(e=d.split(";"),b=0;b<e.length;b++)c=e[b].split("="),2===c.length&&(a[c[0][j]()]=c[1]);return a[g]||(h=a.endpointsuffix,i=h?a.location:null,a[g]="https://"+(i?i+".":"")+"dc."+(h||"services.visualstudio.com")),a}(),p=o[n]||f[n]||"",k=o[g],d=k?k+"/v2/track":f.endpointUrl,(m=[]).push((i="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",t=h,u=d,(s=(v=w(p,"Exception")).data).baseType="ExceptionData",s.baseData.exceptions=[{typeName:"SDKLoadFailed",message:i.replace(/\./g,"-"),hasFullStack:!1,stack:i+"\nSnippet failed to load ["+t+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(e&&e.pathname||"_unknown_")+"\nEndpoint: "+u,parsedStack:[]}],v)),m.push(function(g,f,d,e){var b=w(p,"Message"),c=b.data,a;return c.baseType="MessageData",a=c.baseData,a.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+d+")").replace(/\"/g,"")+'"',a.properties={endpoint:e},b}(0,0,h,d)),function(e,f){var d,c;JSON&&(d=b.fetch,d&&!a.useXhr?d(f,{method:l,body:JSON.stringify(e),mode:"cors"}):XMLHttpRequest&&(c=new XMLHttpRequest,c.open(l,f),c.setRequestHeader("Content-type","application/json"),c.send(JSON.stringify(e))))}(m,d))}function t(b,a){q||setTimeout(function(){!a&&c.core||u()},500)}s=function(){var b=d.createElement(o),c;return b.src=r,c=a[h],!c&&""!==c||"undefined"==b[h]||(b[h]=c),b.onload=t,b.onerror=u,b.onreadystatechange=function(c,a){"loaded"!==b.readyState&&"complete"!==b.readyState||t(0,a)},b}(),a.ld<0?d.getElementsByTagName("head")[0].appendChild(s):setTimeout(function(){d.getElementsByTagName(o)[0].parentNode.appendChild(s)},a.ld||0)}try{c.cookie=d.cookie}catch(a){}function v(a){for(;a.length;)!function(a){c[a]=function(){var b=arguments;z||c.queue.push(function(){c[a].apply(c,b)})}}(a.pop())}return m="track",x="TrackPage",y="TrackEvent",v([m+"Event",m+"PageView",m+"Exception",m+"Trace",m+"DependencyData",m+"Metric",m+"PageViewPerformance","start"+x,"stop"+x,"start"+y,"stop"+y,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),c.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4},B=(f.extensionConfig||{}).ApplicationInsightsAnalytics||{},!0!==f[k]&&!0!==B[k]&&(p="onerror",v(["_"+p]),A=b[p],b[p]=function(a,b,d,e,f){var g=A&&A(a,b,d,e,f);return!0!==g&&c["_"+p]({message:a,url:b,lineNumber:d,columnNumber:e,error:f}),g},f.autoExceptionInstrumented=!0),c}(a.cfg);function p(){a.onInit&&a.onInit(c)}(b[f]=c).queue&&0===c.queue.length?(c.queue.push(p),c.trackPageView({})):p()}(window,document,{src:"https://js.monitor.azure.com/scripts/b/ai.2.min.js",crossOrigin:"anonymous",cfg:{connectionString:"InstrumentationKey=74cc5c48-d066-4928-932e-459f438b579d;IngestionEndpoint=https://uksouth-1.in.applicationinsights.azure.com/;LiveEndpoint=https://uksouth.livediagnostics.monitor.azure.com/"}})</script></head><body><div class=container><header><section><h1 class=site-heading>Stuart McColl</h1><nav><ul><li><a href=/>Blog</a></li><li><a href=/about>About</a></li></ul></nav></section></header><hr><div class=content><main class=post><article><header><h1 class=post-title>Sync contents between two S3 Buckets</h1><p class=post-date>January 14, 2023</p></header><hr class=post-rule><div class=post-content><p>Something I&rsquo;ve had to do on more than one occassion recently is copy the
contents of one S3 bucket to another S3 bucket. There is no built-in way
of doing this in the AWS Management Console, but it <em>is</em> possible using
the AWS Command Line Interface (CLI).</p><p>As an example, I&rsquo;m going to create two new S3 buckets in my AWS account
using Terraform, push some objects into my source bucket, and then copy
the contents of this bucket into my target bucket. If you&rsquo;d like to
skip the setup and jump straight to the instructions, head to the
<a href=#syncing-contents>Syncing contents</a> section.</p><h2 id=provisioning-our-infrastructure>Provisioning our infrastructure</h2><p>I&rsquo;m going to use Terraform to create two S3 buckets with some basic
configuration, one named <code>${account-id}-source</code>, and the other named
<code>${account-id}-target</code>. If you&rsquo;re playing along, the following steps
assume that you have Terraform installed and AWS credentials configured
locally.</p><p>First, we&rsquo;ll create a new directory to store out Terraform files.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir sync-s3-bucket-contents
</code></pre></div><p>In this directory, we&rsquo;ll create a new <code>versions.tf</code> file.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>touch versions.tf
</code></pre></div><p>In this file we&rsquo;ll declare our required Terraform version and provider(s).</p><div class=highlight><pre class=chroma><code class=language-terraform data-lang=terraform><span class=nx>terraform</span> <span class=p>{</span>
  <span class=na>required_version</span> = <span class=s2>&#34;&gt;= 1.3.6&#34;</span>

  <span class=nx>required_providers</span> <span class=p>{</span>
    <span class=na>aws</span> = <span class=p>{</span>
      <span class=na>source</span>  = <span class=s2>&#34;hashicorp/aws&#34;</span>
      <span class=na>version</span> = <span class=s2>&#34;&gt;= 4.50.0&#34;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Next, we&rsquo;ll create a new <code>main.tf</code> file.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>touch main.tf
</code></pre></div><p>In this file, we&rsquo;ll utilise our provider:</p><div class=highlight><pre class=chroma><code class=language-terraform data-lang=terraform><span class=kr>provider</span> <span class=s2>&#34;aws&#34;</span> <span class=p>{</span>
  <span class=na>region</span> = <span class=nx>local</span><span class=p>.</span><span class=nx>region</span>
<span class=p>}</span>
</code></pre></div><p>We&rsquo;ll declare our local variables:</p><div class=highlight><pre class=chroma><code class=language-terraform data-lang=terraform><span class=nx>locals</span> <span class=p>{</span>
  <span class=na>account_id</span> = <span class=nb>data</span><span class=p>.</span><span class=nx>aws_caller_identity</span><span class=p>.</span><span class=nx>current</span><span class=p>.</span><span class=nx>account_id</span>
  <span class=na>region</span>     = <span class=s2>&#34;eu-west-2&#34;</span>
<span class=p>}</span>
</code></pre></div><p>And we&rsquo;ll grab the AWS account identifier being used, so that we can
use that in our S3 bucket names to ensure that they&rsquo;re unique:</p><div class=highlight><pre class=chroma><code class=language-terraform data-lang=terraform><span class=kr>data</span> <span class=s2>&#34;aws_caller_identity&#34;</span> <span class=s2>&#34;current&#34;</span> <span class=p>{}</span>
</code></pre></div><p>Finally, we&rsquo;ll declare our S3 buckets:</p><div class=highlight><pre class=chroma><code class=language-terraform data-lang=terraform><span class=kr>module</span> <span class=s2>&#34;s3_source_bucket&#34;</span> <span class=p>{</span>
  <span class=na>source</span> = <span class=s2>&#34;terraform-aws-modules/s3-bucket/aws&#34;</span>

  <span class=na>bucket</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nx>local</span><span class=p>.</span><span class=nx>account_id</span><span class=si>}</span><span class=s2>-source-bucket&#34;</span>

  <span class=na>block_public_acls</span>       = <span class=kc>true</span>
  <span class=na>block_public_policy</span>     = <span class=kc>true</span>
  <span class=na>ignore_public_acls</span>      = <span class=kc>true</span>
  <span class=na>restrict_public_buckets</span> = <span class=kc>true</span>

  <span class=na>acl</span> = <span class=s2>&#34;private&#34;</span>

  <span class=na>server_side_encryption_configuration</span> = <span class=p>{</span>
    <span class=na>rule</span> = <span class=p>{</span>
      <span class=na>apply_server_side_encryption_by_default</span> = <span class=p>{</span>
        <span class=na>sse_algorithm</span> = <span class=s2>&#34;AES256&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
<span class=kr>
</span><span class=kr>module</span> <span class=s2>&#34;s3_target_bucket&#34;</span> <span class=p>{</span>
  <span class=na>source</span> = <span class=s2>&#34;terraform-aws-modules/s3-bucket/aws&#34;</span>

  <span class=na>bucket</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nx>local</span><span class=p>.</span><span class=nx>account_id</span><span class=si>}</span><span class=s2>-target-bucket&#34;</span>

  <span class=na>block_public_acls</span>       = <span class=kc>true</span>
  <span class=na>block_public_policy</span>     = <span class=kc>true</span>
  <span class=na>ignore_public_acls</span>      = <span class=kc>true</span>
  <span class=na>restrict_public_buckets</span> = <span class=kc>true</span>

  <span class=na>acl</span> = <span class=s2>&#34;private&#34;</span>

  <span class=na>server_side_encryption_configuration</span> = <span class=p>{</span>
    <span class=na>rule</span> = <span class=p>{</span>
      <span class=na>apply_server_side_encryption_by_default</span> = <span class=p>{</span>
        <span class=na>sse_algorithm</span> = <span class=s2>&#34;AES256&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Altogether, our <code>main.tf</code> file should look like this:</p><div class=highlight><pre class=chroma><code class=language-terraform data-lang=terraform><span class=kr>provider</span> <span class=s2>&#34;aws&#34;</span> <span class=p>{</span>
  <span class=na>region</span> = <span class=nx>local</span><span class=p>.</span><span class=nx>region</span>
<span class=p>}</span>

<span class=nx>locals</span> <span class=p>{</span>
  <span class=na>account_id</span> = <span class=nb>data</span><span class=p>.</span><span class=nx>aws_caller_identity</span><span class=p>.</span><span class=nx>current</span><span class=p>.</span><span class=nx>account_id</span>
  <span class=na>region</span>     = <span class=s2>&#34;eu-west-2&#34;</span>
<span class=p>}</span>
<span class=kr>
</span><span class=kr>data</span> <span class=s2>&#34;aws_caller_identity&#34;</span> <span class=s2>&#34;current&#34;</span> <span class=p>{}</span>
<span class=kr>
</span><span class=kr>module</span> <span class=s2>&#34;s3_source_bucket&#34;</span> <span class=p>{</span>
  <span class=na>source</span> = <span class=s2>&#34;terraform-aws-modules/s3-bucket/aws&#34;</span>

  <span class=na>bucket</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nx>local</span><span class=p>.</span><span class=nx>account_id</span><span class=si>}</span><span class=s2>-source-bucket&#34;</span>

  <span class=na>block_public_acls</span>       = <span class=kc>true</span>
  <span class=na>block_public_policy</span>     = <span class=kc>true</span>
  <span class=na>ignore_public_acls</span>      = <span class=kc>true</span>
  <span class=na>restrict_public_buckets</span> = <span class=kc>true</span>

  <span class=na>acl</span> = <span class=s2>&#34;private&#34;</span>

  <span class=na>server_side_encryption_configuration</span> = <span class=p>{</span>
    <span class=na>rule</span> = <span class=p>{</span>
      <span class=na>apply_server_side_encryption_by_default</span> = <span class=p>{</span>
        <span class=na>sse_algorithm</span> = <span class=s2>&#34;AES256&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
<span class=kr>
</span><span class=kr>module</span> <span class=s2>&#34;s3_target_bucket&#34;</span> <span class=p>{</span>
  <span class=na>source</span> = <span class=s2>&#34;terraform-aws-modules/s3-bucket/aws&#34;</span>

  <span class=na>bucket</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nx>local</span><span class=p>.</span><span class=nx>account_id</span><span class=si>}</span><span class=s2>-target-bucket&#34;</span>

  <span class=na>block_public_acls</span>       = <span class=kc>true</span>
  <span class=na>block_public_policy</span>     = <span class=kc>true</span>
  <span class=na>ignore_public_acls</span>      = <span class=kc>true</span>
  <span class=na>restrict_public_buckets</span> = <span class=kc>true</span>

  <span class=na>acl</span> = <span class=s2>&#34;private&#34;</span>

  <span class=na>server_side_encryption_configuration</span> = <span class=p>{</span>
    <span class=na>rule</span> = <span class=p>{</span>
      <span class=na>apply_server_side_encryption_by_default</span> = <span class=p>{</span>
        <span class=na>sse_algorithm</span> = <span class=s2>&#34;AES256&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>With that in place, we&rsquo;ll run <code>terraform init</code> to initiliase everything,
followed by <code>terraform validate</code> to ensure that everything we&rsquo;ve written is
valid Terraform code. <code>terraform plan</code> will tell us exactly what Terraform will
provision. Finally, running <code>terraform apply</code> will provision our infrastructure.</p><h2 id=adding-items-to-our-source-s3-bucket>Adding items to our source S3 bucket</h2><p>Again, if you&rsquo;re playing along, the following section assumes that you have
the AWS CLI installed, and AWS credentials configured locally.</p><p>I&rsquo;ve created two <code>.txt</code> files locally, <code>test-1.txt</code> and <code>test-2.txt</code>. To move
these from my local machine into our source S3 bucket, I can use the following
AWS CLI command:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>aws s3 mv test-1.txt s3://<span class=si>${</span><span class=nv>my</span><span class=p>-account-id</span><span class=si>}</span>-source-bucket
aws s3 mv test-2.txt s3://<span class=si>${</span><span class=nv>my</span><span class=p>-account-id</span><span class=si>}</span>-source-bucket
</code></pre></div><p>To check that the files have successfully been moved, I can run the following
AWS CLI command:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>aws s3 ls <span class=si>${</span><span class=nv>my</span><span class=p>-account-id</span><span class=si>}</span>-source-bucket
</code></pre></div><h2 id=syncing-contents>Syncing contents</h2><p>Now, to sync the contents from the source bucket to the target bucket, I run
the following AWS CLI command:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>aws s3 sync s3://<span class=si>${</span><span class=nv>my</span><span class=p>-account-id</span><span class=si>}</span>-source-bucket s3://<span class=si>${</span><span class=nv>my</span><span class=p>-account-id</span><span class=si>}</span>-target-bucket
</code></pre></div><h2 id=tearing-down-our-infrastructure>Tearing down our infrastructure</h2><p>Finally, to remove the infrastructure I provisioned for this example, I can
run <code>terraform destroy</code>.</p></div></article></main></div><hr><footer><section><h3>More</h3><ul><li><a href=https://hachyderm.io/@stuartmccoll rel=me>Contact me on Mastodon</a></li><li>Spotted a bug in the site?
<a href=https://github.com/stuartmccoll/hugo-theme-refresh/issues/new>Raise an issue on GitHub</a></li><li>Get notifications of new posts by
<a href=https://stuartmccoll.github.io/index.xml>subscribing to my RSS feed</a></li><li>This static site was generated using
<a href=https://github.com/gohugoio/hugo/releases/tag/v0.83.1>Hugo version 0.83.1</a></li></ul></section><hr><section><h3>Attribution</h3><p xmlns:dct=http://purl.org/dc/terms/ xmlns:cc=http://creativecommons.org/ns# class=license-text>This blog post <span rel=dct:title>(Sync contents between two S3 Buckets)</span> is licensed under
<a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a>. Any code contained within
this article may be subject to other licenses.</p></section></footer></div></body></html>